name: Permanent-RDP-Secure

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    steps:
    - name: إعداد المستخدم RDP
      run: |
        Write-Host "👤 إنشاء مستخدم RDP ثابت..."
        $userExists = Get-LocalUser -Name "kamel007" -ErrorAction SilentlyContinue
        if (-not $userExists) {
          net user kamel007 Kamel@123 /add
          net localgroup administrators kamel007 /add
          Write-Host "✅ تم إنشاء المستخدم kamel007"
        } else {
          Write-Host "ℹ️ المستخدم موجود بالفعل"
        }

    - name: تفعيل RDP وفتح البورت 30120
      run: |
        Write-Host "🔧 تفعيل RDP..."
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0

        Write-Host "🛡️ ضبط Firewall Rules..."
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        # السماح فقط على البورت 30120
        New-NetFirewallRule -DisplayName "Allow RDP Custom Port" -Direction Inbound -Action Allow -Protocol TCP -LocalPort 30120 -Profile Any

    - name: ضبط IP ثابت
      run: |
        Write-Host "📌 ضبط IP ثابت: 192.168.0.50"
        $interface = Get-NetAdapter | Where-Object { $_.Status -eq "Up" }
        New-NetIPAddress -InterfaceIndex $interface.InterfaceIndex -IPAddress 192.168.0.50 -PrefixLength 24 -DefaultGateway 192.168.0.1 -ErrorAction SilentlyContinue

    - name: حذف التطبيقات إلا Chrome
      run: |
        Write-Host "🧹 حذف كل البرامج المثبتة باستثناء Google Chrome..."
        $apps = Get-WmiObject -Class Win32_Product | Where-Object { $_.Name -notlike "*Google Chrome*" }
        foreach ($app in $apps) {
          Write-Host "❌ إزالة: $($app.Name)"
          try {
            $app.Uninstall() | Out-Null
            Write-Host "✅ تم الحذف"
          } catch {
            Write-Host "⚠️ فشل الحذف: $($app.Name)"
          }
        }

    - name: تفعيل حماية Windows Defender الأساسية
      run: |
        Write-Host "🛡️ تفعيل Windows Defender وحماية الوقت الحقيقي..."
        Set-MpPreference -DisableRealtimeMonitoring $false
        Set-MpPreference -EnableNetworkProtection Enabled
        Set-MpPreference -PUAProtection Enabled

    - name: تفعيل Account Lockout Policy
      run: |
        Write-Host "🔒 تفعيل سياسة Account Lockout ضد Brute Force..."
        secedit /export /cfg secconfig.cfg
        (Get-Content secconfig.cfg) -replace 'LockoutBadCount = 0', 'LockoutBadCount = 5' | Set-Content secconfig.cfg
        (Get-Content secconfig.cfg) -replace 'ResetLockoutCount = 0', 'ResetLockoutCount = 30' | Set-Content secconfig.cfg
        secedit /configure /db secedit.sdb /cfg secconfig.cfg /areas SECURITYPOLICY
        Remove-Item secconfig.cfg

    - name: عرض بيانات الدخول والحماية
      run: |
        Write-Output "============================================"
        Write-Output "🌐 IP ثابت: 192.168.0.50"
        Write-Output "👤 المستخدم: kamel007"
        Write-Output "🔑 كلمة المرور: Kamel@123"
        Write-Output "🔌 بورت RDP: 30120"
        Write-Output "🛡️ حماية أساسية مفعلة (Firewall, Defender, Lockout Policy)"
        Write-Output "📢 تأكد من فتح البورت 30120 من الراوتر إذا كان الجهاز خلف شبكة"
        Write-Output "============================================"
